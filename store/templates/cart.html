{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Giỏ hàng của bạn</h2>
    <a href="{{ url_for('products') }}" class="btn btn-outline-secondary">Tiếp tục mua</a>
  </div>

  {% if not items %}
    <div class="alert alert-info">Giỏ hàng trống.</div>
  {% else %}
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th style="min-width:250px">Sản phẩm</th>
            <th style="width:120px">Số lượng</th>
            <th style="width:140px">Đơn giá</th>
            <th style="width:140px">Thành tiền</th>
            <th style="width:120px"></th>
          </tr>
        </thead>
        <tbody id="cartBody">
          {% for it in items %}
          <tr data-pid="{{ it.product.id }}">
            <td class="d-flex align-items-center">
              {% if it.product.image %}
                {% if it.product.image.startswith('http') %}
                  <img src="{{ it.product.image }}" alt="{{ it.product.title }}"
                    style="width:74px;height:74px;object-fit:cover;border-radius:6px;margin-right:12px;">
                {% else %}
                  <img src="{{ url_for('static', filename='images/' ~ it.product.image) }}" alt="{{ it.product.title }}"
                    style="width:74px;height:74px;object-fit:cover;border-radius:6px;margin-right:12px;">
                {% endif %}
              {% endif %}
              <div>
                <div class="fw-semibold">{{ it.product.title }}</div>
                <div class="text-muted small">{{ it.product.category or '' }}</div>
              </div>
            </td>
            <td>
              <input type="number" min="0" step="1" class="form-control qty-input" data-pid="{{ it.product.id }}" value="{{ it.qty }}" style="width:110px;">
            </td>
            <td>
              ${{ '%.2f'|format(it.product.price) }}
            </td>
            <td class="line-subtotal">
              ${{ '%.2f'|format(it.product.price * it.qty) }}
            </td>
            <td>
              <button class="btn btn-sm btn-outline-danger btn-remove" data-pid="{{ it.product.id }}">Xóa</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-end align-items-center mt-3">
      <div class="me-4 text-end">
        <div class="small text-muted">Tổng</div>
        <div id="cartTotal" class="h4 mb-0">${{ '%.2f'|format(total) }}</div>
      </div>
      <div>
        <!-- Thay bằng route thanh toán thật khi có -->
        <script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=USD"></script>

<div id="paypal-button-container" class="mt-3"></div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    paypal.Buttons({
      createOrder: function(data, actions) {
        return fetch("/api/create-paypal-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            purchase_units: [{
              amount: {
                currency_code: "USD",
                value: "{{ '%.2f'|format(total) }}"
              }
            }]
          })
        })
        .then(res => res.json())
        .then(data => data.orderID);
      },
      onApprove: function(data, actions) {
        return fetch(`/api/capture-paypal-order/${data.orderID}`, {
          method: "POST"
        })
        .then(res => res.json())
        .then(result => {
          alert("✅ Thanh toán thành công!");
          window.location.href = "/";  // hoặc chuyển hướng đến trang cảm ơn
        })
        .catch(err => {
          console.error(err);
          alert("❌ Lỗi khi xác nhận thanh toán");
        });
      }
    }).render("#paypal-button-container");
  });
</script>
      </div>
    </div>
  {% endif %}
</div>

<script>
/*
  cart.html JS:
  - bắt event change trên .qty-input => gọi /cart/update {product_id, qty}
  - nút .btn-remove gọi /cart/update với qty=0
  - cập nhật subtotal và tổng trên trang khi API trả success
*/

function formatMoney(n) {
  return '$' + (Number(n) || 0).toFixed(2);
}

async function updateCartOnServer(productId, qty) {
  const body = new URLSearchParams();
  body.append('product_id', productId);
  body.append('qty', qty);
  const res = await fetch('/cart/update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: body.toString()
  });
  if (!res.ok) throw new Error('Server returned ' + res.status);
  return await res.json();
}

function recalcTotalsFromServerData(cartJson) {
  // cartJson is the response from /api/cart (if you choose to call it).
  if (!cartJson) return;
  document.getElementById('cartTotal').innerText = '$' + (cartJson.total || 0).toFixed(2);
  // update counts in page rows
  (cartJson.items || []).forEach(item => {
    const row = document.querySelector(`tr[data-pid="${item.id}"]`);
    if (row) {
      const qtyInput = row.querySelector('.qty-input');
      if (qtyInput) qtyInput.value = item.qty;
      const subtotalCell = row.querySelector('.line-subtotal');
      if (subtotalCell) subtotalCell.innerText = formatMoney(item.subtotal);
    }
  });
  // remove rows that no longer exist
  const pids = (cartJson.items || []).map(i => String(i.id));
  document.querySelectorAll('#cartBody tr').forEach(row => {
    const pid = row.getAttribute('data-pid');
    if (!pids.includes(pid)) row.remove();
  });
  // if no items left, reload page to show empty state (or show message)
  if (!cartJson.items || cartJson.items.length === 0) {
    location.reload();
  }
}

document.addEventListener('DOMContentLoaded', () => {
  // change qty handler
  document.querySelectorAll('.qty-input').forEach(input => {
    input.addEventListener('change', async (e) => {
      const pid = e.target.dataset.pid;
      let qty = parseInt(e.target.value) || 0;
      try {
        const data = await updateCartOnServer(pid, qty);
        // Try to use /api/cart to get updated totals (recommended)
        const cartResp = await fetch('/api/cart');
        if (cartResp.ok) {
          const cartJson = await cartResp.json();
          recalcTotalsFromServerData(cartJson);
        } else {
          // fallback: update subtotal cell directly (client-side)
          const row = document.querySelector(`tr[data-pid="${pid}"]`);
          if (row) {
            const price = parseFloat(row.querySelector('td:nth-child(3)').innerText.replace('$','')) || 0;
            row.querySelector('.line-subtotal').innerText = formatMoney(price * qty);
            // update total by re-summing
            let total = 0;
            document.querySelectorAll('#cartBody .line-subtotal').forEach(cell => {
              total += parseFloat(cell.innerText.replace('$','')) || 0;
            });
            document.getElementById('cartTotal').innerText = formatMoney(total);
          }
        }
      } catch (err) {
        console.error(err);
        alert('Không thể cập nhật giỏ hàng. Thử lại.');
      }
    });
  });

  // remove button handler
  document.querySelectorAll('.btn-remove').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const pid = btn.dataset.pid;
      if (!confirm('Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?')) return;
      try {
        await updateCartOnServer(pid, 0);
        // fetch updated cart and re-render totals / remove row
        const cartResp = await fetch('/api/cart');
        if (cartResp.ok) {
          const cartJson = await cartResp.json();
          recalcTotalsFromServerData(cartJson);
        } else {
          // fallback: remove row and recalc
          const row = document.querySelector(`tr[data-pid="${pid}"]`);
          if (row) row.remove();
          let total = 0;
          document.querySelectorAll('#cartBody .line-subtotal').forEach(cell => {
            total += parseFloat(cell.innerText.replace('$','')) || 0;
          });
          document.getElementById('cartTotal').innerText = formatMoney(total);
          if (!document.querySelectorAll('#cartBody tr').length) location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('Xảy ra lỗi khi xóa sản phẩm.');
      }
    });
  });
});
</script>
{% endblock %}
